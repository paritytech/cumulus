# This file is part of .gitlab-ci.yml
# Here are all jobs that are executed during "integration_stage" stage

integration-tests-build-polkadot:
  stage: build
  extends:
    - .docker-env
    - .integration-tests-refs
    - .collect-artifacts
  variables:
    GIT_STRATEGY: none
  script:
    # -------------for tests-----------------
    - export CI_COMMIT_REF_NAME="release-parachains-v9430"
    # ---------------------------------------
    # transform v9430 to v0.9.43
    - export VERSION=$(echo ${CI_COMMIT_REF_NAME} | cut -d "-" -f 3 | sed -e "s/\(.\)\(.\)\(...\)/\10.\2.\3/")
    - export BRANCH="it/release-${VERSION:0:-1}-fast-sudo"
    - echo $VERSION $BRANCH
    - git clone https://github.com/paritytech/polkadot
    - mkdir -p ./artifacts
    - cd polkadot
    - git fetch origin $BRANCH
    - git checkout $BRANCH
    - cargo build --release --features fast-runtime
    - mv ./target/release/polkadot ../artifacts/.

integration-tests-run:
  stage: integration-tests
  extends:
    - .docker-env
    - .integration-tests-refs
    - .collect-artifacts
  image: node:20
  artifacts:
    name: "${CI_JOB_NAME}_${CI_COMMIT_REF_NAME}"
    when: always
    expire_in: 1 days
    paths:
      - ./logs/
  needs:
    - job: build-linux-stable
      artifacts: true
    - job: integration-tests-build-polkadot
      artifacts: true
  before_script:
    - echo ok
  script:
    - mkdir -p ./bin
    - mkdir -p ./logs
    - mv artifacts/polkadot ./bin/
    - mv artifacts/polkadot-parachain ./bin/
    - yarn global add @parity/parachains-integration-tests
    # - sleep 3600
    - ./scripts/parachains_integration_tests.sh
    # ---------- DEBUG -------------------
    # - export TEST_NAME="assets/asset-hub-kusama"
    # - mkdir -p logs/$TEST_NAME
    # - |
    #   DEBUG=zombie::metrics parachains-integration-tests \
    #     -m zombienet \
    #     -c ./parachains/integration-tests/e2e/$TEST_NAME/config.toml \
    #     -cl ./logs/$TEST_NAME/chains.log || sleep 7200
    # - sleep 7200
