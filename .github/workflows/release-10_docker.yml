name: Release - Docker

on:
  release:
    types:
      - published
      - edited

jobs:
  docker_build_publish:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch files from release
        run: |
          echo Repo: ${{ github.event.repository.full_name }}

          echo Name: ${{ github.event.release.name }}
          echo Tag: ${{ github.event.release.tag_name }}
          echo Draft: ${{ github.event.release.draft }}
          echo Prerelease: ${{ github.event.release.prerelease }}
          echo Assets: ${{ github.event.release.assets }}

          for f in polkadot-collator polkadot-collator.asc polkadot-collator.sha256; do
            URL="https://github.com/${{ github.event.repository.full_name }}/releases/download/${{ github.event.release.tag_name }}/$f"
            echo " - Fetching $f from $URL"
            wget $URL -O $f
          done
          ls -al

      - name: Check files
        run: |
          echo TODO
          ls -al *collator*
          shasum -a 256 -c polkadot-collator.sha256
          sha_result=$?
          echo sha_result: $sha_result

          # Parity Security
          gpg --receive-keys 9D4B2B6EB8F97156D19669A9FF0812D491B96798

          # Chevdor
          gpg --receive-keys 2835EAF92072BC01D188AF2C4A092B93E97CE1E2

          gpg --verify polkadot-collator.asc
          gpg_result=$?
          echo gpg_result: $gpg_result

      - name: Checkout sources
        uses: actions/checkout@v2
        with:
          ref: ${{ github.event.release.tag_name }}

      - name: Build injected image
        run: |
          cp polkadot-collator* target/release/
          ./docker/scripts/build-injected-image.sh

      - name: Tag and Publish
        run: |
          docker images
